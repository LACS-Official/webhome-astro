---
import type { Projects as Props } from '~/types';
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import { Icon } from 'astro-icon/components';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline,
  projects = [],
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// 按ID降序排列项目（最新的项目显示在最前面）
const sortedProjects = [...projects].sort((a, b) => b.id - a.id);
---

<WidgetWrapper
  id={id}
  isDark={isDark}
  containerClass={`max-w-7xl mx-auto relative ${classes?.container ?? ''}`}
  bg={bg}
>
  <div
    class="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:40px_40px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)] pointer-events-none"
  >
  </div>
  <Headline title={title} subtitle={subtitle} tagline={tagline} />

  <!-- 项目分类筛选按钮 -->
  <div class="flex flex-wrap justify-center gap-4 mb-12" id="project-filters">
    <button
      class="filter-btn active group relative inline-flex items-center justify-center px-6 py-2 overflow-hidden text-sm font-bold text-white rounded-full bg-slate-900 shadow-[0_1px_15px_rgba(15,23,42,0.1)] transition-all duration-300 hover:scale-105 active:scale-95"
      data-category="all"
    >
      <span class="relative z-10">全部项目</span>
    </button>
    <button
      class="filter-btn group relative inline-flex items-center justify-center px-6 py-2 overflow-hidden text-sm font-bold text-slate-600 dark:text-slate-400 rounded-full border border-slate-200 dark:border-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all duration-300 hover:scale-105 active:scale-95 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm"
      data-category="project1"
    >
      <span class="relative z-10">玩机工具</span>
    </button>
    <button
      class="filter-btn group relative inline-flex items-center justify-center px-6 py-2 overflow-hidden text-sm font-bold text-slate-600 dark:text-slate-400 rounded-full border border-slate-200 dark:border-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all duration-300 hover:scale-105 active:scale-95 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm"
      data-category="project2"
    >
      <span class="relative z-10">面具模块</span>
    </button>
    <button
      class="filter-btn group relative inline-flex items-center justify-center px-6 py-2 overflow-hidden text-sm font-bold text-slate-600 dark:text-slate-400 rounded-full border border-slate-200 dark:border-slate-800 hover:border-slate-400 dark:hover:border-slate-600 transition-all duration-300 hover:scale-105 active:scale-95 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm"
      data-category="project3"
    >
      <span class="relative z-10">小工具</span>
    </button>
  </div>

  <!-- 项目卡片网格 -->
  <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6" id="projects-grid">
    {
      sortedProjects.map((project) => (
        <div
          class="project-card group relative bg-[var(--glass-bg)] backdrop-blur-[var(--glass-blur)] border border-[var(--glass-border)] rounded-3xl p-5 md:p-8 shadow-[var(--shadow-boutique-lg)] hover:shadow-[var(--shadow-boutique-xl)] hover:-translate-y-2 transition-all duration-500 flex flex-col h-full overflow-hidden"
          data-category={project.category}
        >
          <!-- 饰点 -->
          <div class="absolute -right-4 -top-4 w-20 h-20 bg-primary/5 rounded-full blur-2xl group-hover:bg-primary/10 transition-colors"></div>

          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 md:mb-4 gap-2">
            <div class="flex items-center w-full min-w-0">
              <div class="w-10 h-10 md:w-14 md:h-14 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center justify-center mr-3 md:mr-4 shrink-0 transition-all duration-500 group-hover:bg-primary group-hover:rotate-6 shadow-inner border border-slate-100 dark:border-slate-700/50">
                <Icon
                  name={
                    project.icon && /^[a-zA-Z0-9-]+$/.test(project.icon.replace('fa-', ''))
                      ? `tabler:${project.icon.replace('fa-', '')}`
                      : 'tabler:box'
                  }
                  class="w-5 h-5 md:w-7 md:h-7 text-slate-600 dark:text-slate-300 transition-colors duration-500 group-hover:text-white"
                />
              </div>
              <div class="min-w-0 flex-grow relative overflow-hidden">
                <div class="overflow-x-auto no-scrollbar whitespace-nowrap md:whitespace-normal mask-fade-right">
                  <h3 class="text-sm md:text-lg font-extrabold text-gray-900 dark:text-white mb-0 md:mb-1 inline-block md:block">
                    {project.title}
                  </h3>
                </div>
                <span class="text-[10px] md:text-sm text-primary font-medium truncate block">{project.platform}</span>
              </div>
            </div>
            <span class="hidden sm:inline-block text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
              {project.updateDate}
            </span>
          </div>

          <p class="text-gray-600 dark:text-gray-300 mb-3 md:mb-4 text-[11px] md:text-sm leading-relaxed line-clamp-2 md:line-clamp-none flex-grow">
            {project.description}
          </p>

          <div class="flex flex-col gap-3 mt-auto">
            <div class="flex flex-wrap gap-1">
              <span class="text-[10px] md:text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 px-2 md:px-3 py-0.5 md:py-1 rounded-full">
                {project.categoryName}
              </span>
            </div>
            {project.link !== '#' && (
              <a
                href={project.link}
                target="_blank"
                rel="noopener noreferrer"
                data-magnetic
                class="inline-flex items-center justify-center px-2 md:px-4 py-1.5 md:py-2 bg-primary text-white text-[11px] md:text-sm font-medium rounded-lg hover:bg-primary-600 shadow-[var(--glow-primary)] transition-all duration-200 w-full"
              >
                <Icon name="tabler:external-link" class="hidden md:block w-4 h-4 mr-2" />
                访问项目
              </a>
            )}
          </div>
        </div>
      ))
    }
  </div>
</WidgetWrapper>

<script>
  // 项目筛选功能
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const projectCards = document.querySelectorAll('.project-card');

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const category = button.getAttribute('data-category');

        // 更新按钮状态
        filterButtons.forEach((btn) => {
          btn.classList.remove(
            'active',
            'bg-slate-900',
            'text-white',
            'dark:bg-slate-100',
            'dark:text-slate-900',
            'font-bold',
            'shadow-sm'
          );
          btn.classList.add(
            'border-slate-200',
            'dark:border-slate-700',
            'text-slate-600',
            'dark:text-slate-400',
            'font-medium'
          );
        });

        button.classList.add(
          'active',
          'bg-slate-900',
          'text-white',
          'dark:bg-slate-100',
          'dark:text-slate-900',
          'font-bold',
          'shadow-sm'
        );
        button.classList.remove(
          'border-slate-200',
          'dark:border-slate-700',
          'text-slate-600',
          'dark:text-slate-400',
          'font-medium'
        );

        // 筛选项目卡片
        projectCards.forEach((card) => {
          const cardCategory = card.getAttribute('data-category');
          // 修复 TS2339: 类型"Element"上不存在属性"style"
          // 通过类型断言告诉 TypeScript 这是一个 HTMLElement
          const htmlCard = card as HTMLElement;
          if (category === 'all' || cardCategory === category) {
            htmlCard.style.display = 'block';
            htmlCard.classList.add('animate-fade-in');
          } else {
            htmlCard.style.display = 'none';
            htmlCard.classList.remove('animate-fade-in');
          }
        });
      });
    });

    // 项目卡片点击事件
    projectCards.forEach((card) => {
      card.addEventListener('click', () => {
        const title = card.querySelector('h3')?.textContent || '';
        const description = card.querySelector('p')?.textContent || '';
        const imageUrl = card.querySelector('img')?.src || '';
        const links = card.querySelectorAll('a');

        const actions = Array.from(links).map((link) => {
          // 修复 TS18047: "link.textContent"可能为"null"
          const text = link.textContent?.trim() || '';
          return {
            text: text,
            href: link.href,
            target: link.target,
            icon: link.querySelector('i')?.className || 'fas fa-external-link-alt',
          };
        });

        // 修复 TS2339: 类型"Window & typeof globalThis"上不存在属性"showModal"
        // 通过类型断言告诉 TypeScript window 对象上有 showModal 属性
        const win = window as any;
        // 显示模态框
      });
    });
  });
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.5s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .mask-fade-right {
    -webkit-mask-image: linear-gradient(to right, black calc(100% - 20px), transparent 100%);
    mask-image: linear-gradient(to right, black calc(100% - 20px), transparent 100%);
  }
</style>

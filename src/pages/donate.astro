---
// 启用 SSR - 每次请求时动态渲染此页面
export const prerender = false;

import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Content from '~/components/widgets/Content.astro';
import Features from '~/components/widgets/Features.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import heroImage from '~/assets/images/donate.webp';

const metadata = {
  title: '支持我们 - 领创工作室',
  description: '支持领创工作室的发展，您的捐赠将帮助我们提供更好的服务和开发更多优质项目。多种捐赠方式，感谢您的支持！',
  keywords: '捐赠,支持,赞助,领创工作室,开源项目',
};

// 定义捐赠者数据类型
interface Donation {
  name: string;
  amount?: number;
  donationDate: string;
  message?: string;
}

// 获取捐赠者数据
let donationData: Donation[] = [];
let apiError = false;

try {
  // 直接从外部 API 获取捐赠数据
  const response = await fetch('https://api-g.lacs.cc/api/donors');

  if (response.ok) {
    const result = await response.json();
    if (result.success && result.data) {
      donationData = result.data;
      console.log('成功获取捐赠数据，共', donationData.length, '条记录');
    } else {
      console.warn('API 返回数据格式异常:', result);
      apiError = true;
    }
  } else {
    console.error('API 响应错误:', response.status, response.statusText);
    if (response.status === 401) {
      console.error('API 需要身份验证，请检查 API 密钥或认证配置');
    }
    apiError = true;
  }
} catch (error) {
  console.error('获取捐赠数据失败:', error);
  apiError = true;
}

// 如果 API 请求失败
if (apiError || donationData.length === 0) {
  console.log('api获取失败');
}


// 捐赠用途
const donationUsage = [
  {
    title: '服务器维护',
    description: '维护网站服务器、域名续费、CDN加速等基础设施费用。',
    icon: 'tabler:server',
    percentage: '40%',
  },
  {
    title: '项目开发',
    description: '投入新项目的研发，购买开发工具和软件许可证。',
    icon: 'tabler:code',
    percentage: '35%',
  },
  {
    title: '技术学习',
    description: '团队成员技术培训、购买学习资料和参加技术会议。',
    icon: 'tabler:book',
    percentage: '15%',
  },
  {
    title: '社区建设',
    description: '维护技术社区、举办活动、奖励贡献者等。',
    icon: 'tabler:users',
    percentage: '10%',
  },
];

// 支持者权益
const supporterBenefits = [
  {
    title: '专属标识',
    description: '在我们的项目和网站中展示支持者专属标识。',
    icon: 'tabler:badge',
  },
  {
    title: '优先支持',
    description: '享受技术支持和服务的优先处理权。',
    icon: 'tabler:star',
  },
];
---

<Layout metadata={metadata}>
  <CustomStyles />
  
  <!-- Hero Section -->
  <Hero
    tagline="支持我们"
    title="您的支持是我们前进的动力"
    subtitle="领创工作室致力于为用户提供优质的技术服务和开源项目。您的每一份支持都将帮助我们做得更好，为技术社区贡献更多价值。"
    actions={[
      {
        variant: 'primary',
        text: '立即支持',
        href: '#donation-methods',
        icon: 'tabler:heart',
      },
      {
        variant: 'secondary',
        text: '了解用途',
        href: '#usage',
        icon: 'tabler:arrow-down',
      },
    ]}
    image={{ src: heroImage, alt: '展示' }}
  />


  <!-- 二维码展示 -->
  <section class="py-16 md:py-20">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">扫码支持</h2>
        <p class="text-xl text-muted mb-12">使用手机扫描下方二维码即可快速支持</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div id="wechat-qr" class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-green-600">微信支付</h3>
            <div class="w-48 h-48 mx-auto mb-4 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <img src="/images/qrcodes/wechatpay.webp" alt="微信二维码" class="w-full h-full object-cover" />
            </div>
            <p class="text-sm text-muted">微信扫码支付</p>
          </div>
          
          <div id="alipay-qr" class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-blue-600">支付宝</h3>
            <div class="w-48 h-48 mx-auto mb-4 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
              <img src="/images/qrcodes/alipay.webp" alt="支付宝二维码" class="w-full h-full object-cover" />
            </div>
            <p class="text-sm text-muted">支付宝扫码支付</p>
          </div>
        </div>
        
      </div>
    </div>
  </section>

  <!-- 支持者名单 -->
  <section class="py-16 md:py-20">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">感谢支持者</h2>
        <p class="text-xl text-muted mb-12">感谢以下朋友对领创工作室的支持</p>

        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg">
          {donationData.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {donationData.map((supporter) => (
                <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div class="flex items-center justify-between mb-2">
                    <p class="font-semibold text-lg">{supporter.name}</p>
                    <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                      支持者
                    </span>
                  </div>
                  <p class="text-sm text-muted">
                    <i class="fas fa-calendar mr-1"></i>
                    捐赠日期: {supporter.donationDate}
                  </p>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-8">
              <p class="text-muted">暂无支持者数据</p>
            </div>
          )}

          <div class="mt-8 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <p class="text-sm text-muted">
              <i class="fas fa-info-circle mr-2"></i>
              支持者名单实时更新，如需匿名请在支付时备注说明
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 资金用途 -->
  <Features
    id="usage"
    title="资金使用透明化"
    subtitle="您的每一分支持都将用于以下方面"
    tagline="资金用途"
    items={donationUsage.map(usage => ({
      title: usage.title,
      description: `${usage.description}<br><span class="text-primary font-bold">${usage.percentage}</span>`,
      icon: usage.icon,
    }))}
    columns={4}
  />

  <!-- 支持者权益 -->
  <Content
    title="支持者专属权益"
    subtitle="感谢您的支持，我们为支持者准备了专属权益"
    items={supporterBenefits}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight dark:text-white sm:text-3xl mb-2">
        成为我们的支持者
      </h3>
      支持金额不限，每一份心意都是对我们最大的鼓励。我们会定期公布资金使用情况，确保透明公开。
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-blue-50 dark:bg-slate-800"></div>
    </Fragment>
  </Content>




  <!-- Call to Action -->
  <CallToAction
    actions={[
      {
        variant: 'primary',
        text: '立即支持',
        href: '#donation-methods',
        icon: 'tabler:heart',
      },
      {
        variant: 'secondary',
        text: '联系我们',
        href: '/contact',
        icon: 'tabler:message-circle',
      },
    ]}
  >
    <Fragment slot="title">
      感谢您的支持！
    </Fragment>

    <Fragment slot="subtitle">
      您的每一份支持都将帮助我们做得更好，<br class="hidden md:inline" />
      为技术社区贡献更多价值。
    </Fragment>
  </CallToAction>
</Layout>

<style>
  .btn-primary {
    @apply bg-blue-600 text-white hover:bg-blue-700 transition-all duration-300;
  }
</style>

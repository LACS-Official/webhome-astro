---
// 启用 SSR - 每次请求时动态渲染此页面
export const prerender = true;

import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Content from '~/components/widgets/Content.astro';
import Features from '~/components/widgets/Features.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import Modal from '~/components/Modal.astro';
import Skeleton from '~/components/ui/Skeleton.astro';
import { Icon } from 'astro-icon/components';
import SpotlightCard from '~/components/reactbits/SpotlightCard';
import AnimatedContent from '~/components/reactbits/AnimatedContent';
import ShinyText from '~/components/reactbits/ShinyText';
import contactHero from '~/assets/images/heroes/contact-hero.jpg';

// 定义类型接口
interface ContactInfo {
  title: string;
  description: string;
  info: string;
  action: string;
}

interface MediaPlatform {
  name: string;
  logo: string;
  account: string;
  accountId?: string;
  qrcode: string;
  qrcodeTitle?: string;
  qrcodeDesc?: string;
  link: string;
}

interface GroupChat {
  name: string;
  description?: string;
  limit?: string;
  groupNumber?: string;
  qrcode: string;
  joinLink: string;
}

import { fetchWithRetry } from '~/utils/utils';

// API 配置
const API_BASE_URL = 'https://api-g.lacs.cc/api/info-management';

// 获取联系方式数据
let contactInfoData: ContactInfo[] = [];
try {
  const contactResponse = await fetchWithRetry(`${API_BASE_URL}/contact-info`);
  if (contactResponse && contactResponse.ok) {
    const contactResult = await contactResponse.json();
    if (contactResult.success && contactResult.data) {
      contactInfoData = contactResult.data;
      console.log('成功获取联系方式数据，共', contactInfoData.length, '条记录');
    }
  }
} catch (error) {
  console.error('获取联系方式数据失败:', error instanceof Error ? error.message : error);
}

// 获取媒体平台数据
let mediaPlatformsData: MediaPlatform[] = [];
try {
  const mediaResponse = await fetchWithRetry(`${API_BASE_URL}/media-platforms`);
  if (mediaResponse && mediaResponse.ok) {
    const mediaResult = await mediaResponse.json();
    if (mediaResult.success && mediaResult.data) {
      mediaPlatformsData = mediaResult.data;
      console.log('成功获取媒体平台数据，共', mediaPlatformsData.length, '条记录');
    }
  }
} catch (error) {
  console.error('获取媒体平台数据失败:', error instanceof Error ? error.message : error);
}

// 获取群聊数据
let groupChatsData: GroupChat[] = [];
try {
  const groupResponse = await fetchWithRetry(`${API_BASE_URL}/group-chats`);
  if (groupResponse && groupResponse.ok) {
    const groupResult = await groupResponse.json();
    if (groupResult.success && groupResult.data) {
      groupChatsData = groupResult.data;
      console.log('成功获取群聊数据，共', groupChatsData.length, '条记录');
    }
  }
} catch (error) {
  console.error('获取群聊数据失败:', error instanceof Error ? error.message : error);
}

// 转换联系方式数据格式
const contactMethods = contactInfoData.map((contact) => ({
  title: contact.title,
  description: contact.description,
  info: contact.info,
  action: contact.action,
  icon:
    contact.title === '电子邮件'
      ? 'tabler:mail'
      : contact.title === 'QQ'
        ? 'tabler:brand-qq'
        : contact.title === '微信'
          ? 'tabler:brand-wechat'
          : 'tabler:message',
  color: contact.title === '电子邮件' ? 'primary' : contact.title === 'QQ' ? 'secondary' : 'accent',
}));

import heroImage from '~/assets/images/contact.webp';
const metadata = {
  title: '联系我们 - 领创工作室',
  description:
    '联系领创工作室，获取技术支持、商务合作或其他服务。我们提供多种联系方式，24小时内回复您的咨询。了解我们的媒体平台和官方群聊。',
  keywords: '联系我们,技术支持,商务合作,领创工作室,客服,媒体平台,官方群聊',
};
---

<Layout metadata={metadata}>
  <CustomStyles />

  <!-- Hero Section -->
  <Hero
    tagline="联系我们"
    title="随时为您提供专业服务"
    subtitle="领创工作室致力于为用户提供优质的技术支持和服务。关注我们的媒体平台，获取最新资讯和技术分享。"
    image={{
      src: contactHero,
      alt: 'Contact Us background',
    }}
  >
    <div slot="actions" class="flex flex-col sm:flex-row gap-5 justify-center">
      <a
        href="#contact-methods"
        class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 text-lg font-bold rounded-full shadow-[var(--glow-primary)] transition-all duration-300 active:scale-95 flex items-center justify-center w-full sm:w-auto"
      >
        立即联系
      </a>
      <a
        href="#media-platforms"
        class="bg-white/5 backdrop-blur-[var(--glass-blur)] text-white border border-[var(--glass-border)] hover:bg-white/10 hover:border-white/40 px-10 py-4 text-lg font-bold rounded-full shadow-[var(--shadow-boutique-xl)] transition-all duration-300 active:scale-95 flex items-center justify-center w-full sm:w-auto"
      >
        关注我们
      </a>
    </div>
  </Hero>

  <!-- Modal Component -->
  <Modal />

  <AnimatedContent client:visible distance={40}>
    <Features
      id="contact-methods"
      title="联系我们"
      subtitle="选择您喜欢的方式与我们取得联系"
      tagline="沟通渠道"
      items={contactMethods.map((method) => ({
        title: method.title,
        description: `${method.description}<br><strong class="text-primary dark:text-blue-400">${method.info}</strong>`,
        icon: method.icon,
        class: 'hover:shadow-lg hover:-translate-y-1 transition-all duration-300',
        callToAction: {
          text: '立即联系',
          href: method.action,
          target: method.action.startsWith('http') ? '_blank' : '_self',
          variant: 'primary',
          class: 'group',
        },
      }))}
      columns={3}
    >
      <Fragment slot="tagline">
        <ShinyText client:load text="沟通渠道" speed={3} color="#3b82f6" />
      </Fragment>
      <Fragment slot="bg">
        <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-slate-800 dark:to-slate-900">
        </div>
      </Fragment>
    </Features>
  </AnimatedContent>

  <!-- 媒体平台 -->
  <section id="media-platforms" class="py-16 md:py-20 relative">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-900">
    </div>
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="text-center mb-12">
        <div class="inline-block px-3 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded-full mb-4">
          媒体平台
        </div>
        <h2 class="text-3xl md:text-4xl font-bold mb-4">关注我们的媒体平台</h2>
        <p class="text-xl text-muted max-w-2xl mx-auto">获取最新资讯、技术分享和项目动态</p>
      </div>

      <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-6">
        {
          mediaPlatformsData.length > 0 ? (
            mediaPlatformsData.map((platform, index) => (
              <AnimatedContent client:visible delay={index * 0.05} distance={30}>
                <SpotlightCard 
                  client:visible 
                  className="group relative backdrop-blur-md rounded-2xl md:rounded-3xl p-3 sm:p-6 hover:-translate-y-2 transition-all duration-500 overflow-hidden flex flex-col h-full"
                  spotlightColor="rgba(59, 130, 246, 0.1)"
                >
                  <div class="absolute -right-4 -top-4 w-16 h-16 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-colors"></div>
                  
                  <div class="flex flex-col md:flex-row items-center md:items-start text-center md:text-left mb-4 md:mb-6 relative z-10">
                    <div class="relative mb-3 md:mb-0">
                      <div class="absolute inset-0 bg-blue-500/20 blur-lg rounded-full scale-0 group-hover:scale-110 transition-transform duration-500"></div>
                      <img
                        src={platform.logo}
                        alt={platform.name}
                        class="w-12 h-12 md:w-16 md:h-16 rounded-xl md:rounded-2xl relative z-10 object-cover shadow-sm border border-white/50 dark:border-slate-700/50"
                        loading="lazy"
                      />
                    </div>
                    <div class="md:ml-4 flex-grow min-w-0 w-full">
                      <h3 class="text-sm md:text-xl font-black text-slate-800 dark:text-white mb-0.5 md:mb-1 truncate">
                        {platform.name}
                      </h3>
                      <div class="flex items-center justify-center md:justify-start text-[10px] md:text-sm font-medium text-blue-600 dark:text-blue-400">
                        <span class="truncate">@{platform.account}</span>
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-col md:flex-row gap-2 relative z-10 mt-auto">
                    <button
                      class="qr-button flex-1 group/btn relative overflow-hidden bg-slate-800 dark:bg-slate-700 text-white px-2 md:px-4 py-2 md:py-3 rounded-xl md:rounded-2xl transition-all duration-300 shadow-lg shadow-slate-900/10 hover:shadow-slate-900/20 active:scale-95 flex items-center justify-center font-bold text-xs md:text-base"
                      data-qrcode={platform.qrcode}
                      data-title={platform.qrcodeTitle || platform.name}
                      data-description={platform.qrcodeDesc || '扫码关注平台'}
                      data-link={platform.link}
                      type="button"
                    >
                      <span class="relative z-10 flex items-center">
                        <Icon name="tabler:qrcode" class="w-4 h-4 md:w-5 md:h-5 mr-1 md:mr-2" />
                        <span>查看码</span>
                      </span>
                    </button>
                    <a
                      href={platform.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex-1 bg-white dark:bg-slate-800 text-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 px-2 md:px-4 py-2 md:py-3 rounded-xl md:rounded-2xl transition-all duration-300 hover:bg-slate-50 dark:hover:bg-slate-700 active:scale-95 flex items-center justify-center font-bold text-xs md:text-base"
                    >
                      <Icon name="tabler:external-link" class="w-4 h-4 md:w-5 md:h-5 mr-1 md:mr-2" />
                      访问
                    </a>
                  </div>
                </SpotlightCard>
              </AnimatedContent>
            ))
          ) : (
            Array.from({ length: 6 }).map(() => (
              <div class="bg-white/40 dark:bg-slate-800/40 backdrop-blur-md border border-slate-200/50 dark:border-slate-700/50 rounded-2xl md:rounded-3xl p-4 md:p-6 flex flex-col items-center md:items-start">
                <div class="flex flex-col md:flex-row items-center md:items-start w-full mb-4">
                  <Skeleton class="w-12 h-12 md:w-16 md:h-16 rounded-xl md:rounded-2xl mb-3 md:mb-0" />
                  <div class="md:ml-4 flex-grow w-full space-y-2">
                    <Skeleton class="h-6 w-24 mx-auto md:mx-0" />
                    <Skeleton class="h-4 w-32 mx-auto md:mx-0" />
                  </div>
                </div>
                <div class="flex w-full gap-2 mt-auto">
                  <Skeleton class="flex-1 h-10 rounded-xl md:rounded-2xl" />
                  <Skeleton class="flex-1 h-10 rounded-xl md:rounded-2xl" />
                </div>
              </div>
            ))
          )
        }
      </div>
    </div>
  </section>

  <!-- QQ群聊 -->
  <section class="py-16 md:py-24 relative overflow-hidden" id="qun-group">
    <!-- 装饰性背景：数码网格与光斑 -->
    <div class="absolute inset-0 pointer-events-none">
       <div class="absolute inset-0 bg-[linear-gradient(to_right,#e2e8f0_1px,transparent_1px),linear-gradient(to_bottom,#e2e8f0_1px,transparent_1px)] dark:bg-[linear-gradient(to_right,#1e293b_1px,transparent_1px),linear-gradient(to_bottom,#1e293b_1px,transparent_1px)] bg-[size:40px_40px] opacity-[0.4] dark:opacity-[0.2]"></div>
       <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-transparent via-blue-50/50 to-transparent dark:via-blue-900/10"></div>
       <div class="absolute -top-24 -right-24 w-96 h-96 bg-blue-500/5 rounded-full blur-[100px] animate-pulse"></div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="text-center mb-16">
        <div class="inline-flex items-center px-4 py-1.5 text-xs font-bold text-blue-600 bg-blue-100/50 dark:bg-blue-900/30 rounded-full mb-6 border border-blue-200 dark:border-blue-800 tracking-widest uppercase">
          COMMUNITY <span class="mx-2 opacity-30">|</span> 官方群聊
        </div>
        <h2 class="text-4xl md:text-5xl font-black mb-6 tracking-tight text-slate-900 dark:text-white">加入我们的社区</h2>
        <p class="text-xl text-slate-500 dark:text-slate-400 max-w-2xl mx-auto font-medium">与其他用户交流，获取最新资讯和技术支持</p>
      </div>

      <div class="grid grid-cols-2 gap-4 md:gap-8 max-w-5xl mx-auto">
        {
          groupChatsData.map((group, index) => (
            <AnimatedContent client:visible delay={index * 0.1} distance={30}>
              <SpotlightCard 
                client:visible 
                className="group relative backdrop-blur-xl rounded-[2rem] p-3 sm:p-6 hover:-translate-y-2 transition-all duration-500 flex flex-col overflow-hidden h-full"
                spotlightColor="rgba(59, 130, 246, 0.1)"
              >
                <!-- 背景抽象饰纹 -->
                <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl group-hover:bg-blue-500/10 transition-colors"></div>
                
                <div class="flex flex-col md:flex-row items-center md:items-start mb-6 relative z-10">
                  <!-- 非对称图标容器 -->
                  <div class="w-14 h-14 md:w-20 md:h-20 rounded-2xl md:rounded-[1.5rem] mr-0 md:mr-6 bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center mb-4 md:mb-0 transform -rotate-3 group-hover:rotate-0 transition-transform duration-500 shadow-xl shadow-blue-500/20">
                    <Icon name="tabler:brand-qq" class="w-8 h-8 md:w-12 md:h-12 text-white" />
                  </div>
                  <div class="flex-grow text-center md:text-left overflow-hidden">
                    <h3 class="text-base md:text-2xl font-black text-slate-800 dark:text-white mb-1 truncate">{group.name}</h3>
                    <div class="flex flex-col gap-1">
                      {group.limit && <p class="text-[10px] md:text-sm font-bold text-blue-600/70 dark:text-blue-400/70 uppercase tracking-tighter">{group.limit}</p>}
                      <p class="text-[10px] md:text-xs text-slate-400 font-medium">官方合规交流群</p>
                    </div>
                  </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3 w-full mt-auto relative z-10">
                  <button
                    class="flex-1 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-4 py-3 rounded-2xl transition-all duration-300 flex items-center justify-center font-black text-xs md:text-base border border-slate-800 dark:border-white shadow-lg hover:shadow-xl active:scale-95"
                    onclick={`showModal('${group.qrcode}', '${group.name}', '扫码加入群聊', [{text: '直接加入', href: '${group.joinLink}', target: '_blank', icon: 'fas fa-user-plus'}])`}
                  >
                    <Icon name="tabler:qrcode" class="w-5 h-5 mr-2" />
                    查看码
                  </button>
                  <a
                    href={group.joinLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex-1 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-3 rounded-2xl transition-all duration-300 flex items-center justify-center font-black text-xs md:text-base border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-sm active:scale-95"
                  >
                    <Icon name="tabler:user-plus" class="w-5 h-5 mr-2" />
                    加入群
                  </a>
                </div>
              </SpotlightCard>
            </AnimatedContent>
          ))
        }
      </div>
    </div>
  </section>

  <!-- 服务时间和说明 -->
  <Content
    title="服务说明"
    subtitle="了解我们的服务时间和响应政策"
    items={[
      {
        title: '响应时间',
        description: '工作日内24小时回复邮件，QQ和微信消息通常在2小时内回复。',
        icon: 'tabler:clock',
      },
      {
        title: '服务范围',
        description: '技术支持、软件问题、商务合作、远程刷机服务等。',
        icon: 'tabler:tools',
      },
      {
        title: '工作时间',
        description: '周一至周日 9:00-22:00，节假日可能延迟回复。',
        icon: 'tabler:calendar',
      },
    ]}
  >
    <Fragment slot="content">
      <h3 class="text-2xl font-bold tracking-tight dark:text-white sm:text-3xl mb-2">专业的技术支持团队</h3>
      我们拥有经验丰富的技术团队，为您提供专业、及时的技术支持和服务。
    </Fragment>

    <Fragment slot="bg">
      <div class="absolute inset-0 bg-blue-50 dark:bg-slate-800"></div>
    </Fragment>
  </Content>

  <!-- Call to Action -->
  <CallToAction
    actions={[
      {
        variant: 'primary',
        text: '返回首页',
        href: '/',
        icon: 'tabler:home',
      },
      {
        variant: 'secondary',
        text: '查看项目',
        href: '/#projects',
        icon: 'tabler:apps',
      },
    ]}
  >
    <Fragment slot="title"> 还有其他问题？ </Fragment>

    <Fragment slot="subtitle"> 欢迎浏览我们的项目展示，或返回首页了解更多信息。 </Fragment>
  </CallToAction>

  <!-- 二维码按钮事件处理 -->
  <script>
    // 初始化二维码按钮处理 (使用委托)
    function handleQRClick(e) {
      const button = e.target.closest('.qr-button');
      if (!button) return;

      e.preventDefault();
      const qrcode = button.dataset.qrcode;
      const title = button.dataset.title;
      const description = button.dataset.description;
      const link = button.dataset.link;

      console.log('QR button clicked (delegated):', { qrcode, title, description, link });
      
      // 使用增强版弹窗显示二维码
      if (window.showModal) {
        window.showModal(qrcode, title, description, [
          {
            text: '访问链接',
            href: link,
            target: '_blank',
            icon: 'fas fa-external-link-alt',
          },
        ]);
      }
    }

    function setupQRDelegation() {
      // 移除旧的监听器并添加新的
      document.removeEventListener('click', handleQRClick);
      document.addEventListener('click', handleQRClick);
      console.log('QR event delegation setup completed');
    }

    // 页面加载或切换后初始化
    setupQRDelegation();
    
    document.addEventListener('astro:page-load', setupQRDelegation);
    document.addEventListener('astro:after-swap', setupQRDelegation);
  </script>
</Layout>
